<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=320, initial-scale=1.0, maximum-scale=1.0" />
<title>Quoin Control System</title>
<link rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css">
<link rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/css/bootstrap-responsive.css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/highcharts/2.2.1/highcharts.js"></script>
<style type="text/css" media="screen">
  table{width:auto !important;margin:0 auto}
  td,th{padding:0 2em;text-align:center !important}
  p{text-align:center;margin-top:1em}
</style>
<div class="navbar">
  <div class="navbar-inner">
    <div class="container">
      <a class="brand" href="javascript:window.location.reload()">Quoin Control System</a>
      <ul class="nav">
        <li><a href="http://rustynas.no-ip.info:99/">Security Camera</a></li>
      </ul>
    </div>
  </div>
</div>
<div id="loading" class="container">
  <p class="alert alert-info">Loading data from controller...</p>
</div>
<div class="container" style="display:none">
  <p>
    <span class="r1">
      <a class="on toggle btn btn-success">Inverter - On</a>
      <a class="off toggle btn btn-danger">Inverter - Off</a>
      <a class="manual disabled toggle btn btn-inverse">Inverter - Manual</a>
    </span>
    <span class="r2">
      <a class="on toggle btn btn-success">Garden Pump - On</a>
      <a class="off toggle btn btn-danger">Garden Pump - Off</a>
    </span>
  </p>
  <p id="debug"></p>

  <table class="table table-striped">
    <thead>
      <tr>
        <th>Time</th>
        <th>Battery Volts</th>
        <th>AC Power</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td id="dt"></td>
        <td id="b"></td>
        <td id="ac"></td>
      </tr>
    </tbody>
  </table>

  <div id="chart"></div>
</div>
<script>
  var ARDUINO_URI = 'http://59.167.158.82/';
  var chart;

  $('.toggle').hide();

  function scale(num) {return num/100;}
  function callback(context) {
    // Hide loading message and show data
    $('#loading').remove();
    $('.container').show();

    // Adjust data
    context.h1 = context.h1 && $.map(context.h1, scale);
    context.h2 = context.h2 && $.map(context.h2, scale);

    // Extract latest readings
    context.ac = context.h0.slice(-1);
    context.b = context.h1.slice(-1);
    context.s = context.h2.slice(-1);

    // Display data
    $.each(context, function(key, value) {
      $('#'+key).text(value);
    });

    // Render charts
    if (chart && chart.destroy) chart.destroy();
    chart = new Highcharts.Chart({
      chart:{renderTo:'chart', type:'spline', height:400, marginBottom:50},
      title:{text:'History'},
      xAxis:{labels:{enabled:false}},
      plotOptions:{spline:{marker:{enabled:false},animation:false}},
      yAxis:[
        {title:{text:'Voltage'}, opposite:true, min:0, startOnTick:true},
        {title:{text:'AC Power'}, min:0, startOnTick:true}
      ],
      legend:{layout:'horizontal', align:'center', verticalAlign:'bottom', y:-10, borderWidth:0},
      series: [{name:'Battery', yAxis:0, data:context.h2}, {name:'Solar', yAxis:0, data:context.h1}, {name:'AC Power', yAxis:1, data:context.h0}]
    });
    $('tspan:contains(Highcharts.com)').remove();

    // Relays
    $('.toggle').hide(); // Hide buttons
    $('.on, .off').removeClass('disabled');

    // Show appropriate button for each toggle
    $.each(['r1', 'r2'], function(i, relay) {
      var x = context[relay];
      $('.'+relay).find('.'+(x==-1 ? 'manual' : (x==0 ? 'off' : 'on'))).show();;
    });

    // Respond to toggle
    $('a.toggle:not(.disabled)').on('click', function() {
      $('.toggle').addClass('disabled').off('click');
      $.getScript(ARDUINO_URI+'?r='+$(this).parent().attr('class'));
    });
  }

  // Load data
  $.getScript(ARDUINO_URI);

  // Update data
  setInterval(function() {
    $.getScript(ARDUINO_URI);
  }, 30000);
</script>